# App Server 架构设计

## Flask 架构设计

![FLask Logo][server_1]


Flask是一个使用Python编写的轻量级Web应用框架. 基于Werkzeug WSGI(PythonWeb服务器网关接口
（Python Web Server Gateway Interface, 缩写为WSGI)是Python应用程序或框架和Web服务器之
间的一种接口, 已经被广泛接受, 它已基本达成它的可移植性方面的目标)工具箱和 Jinja2 模板引擎. 
Flask使用BSD授权. Flask也被称为“microframework”, 因为它使用简单的核心, 用extension增加
其他功能. Flask没有默认使用的数据库, 认证方式以及管理员界面. 然而, Flask保留了扩增的弹性, 
可以用拓展机制来加入这些功能: ORM, 数据库支持, 文件上传, 各种开放式身份验证技术。

“微”(micro) 并不表示你需要把整个 Web 应用塞进单个 Python 文件（虽然确实可以 ），也不意味着 
Flask 在功能上有所欠缺。微框架中的“微”意味着 Flask 旨在保持核心简单而易于扩展。Flask 不会替
你做出太多决策——比如使用何种数据库。而那些 Flask 所选择的——比如使用何种模板引擎——则很容易替换。
除此之外的一切都由可由你掌握。如此，Flask 可以与您珠联璧合。

默认情况下，Flask 不包含数据库抽象层、表单验证，或是其它任何已有多种库可以胜任的功能。然而，
Flask 支持用扩展来给应用添加这些功能，如同是 Flask 本身实现的一样。众多的扩展提供了数据库集成
、表单验证、上传处理、各种各样的开放认证技术等功能。Flask 也许是“微小”的，但它已准备好在需求繁
杂的生产环境中投入使用。

### RESTful API

REST（英文：Representational State Transfer，又称具象状态传输）是Roy Thomas Fielding
博士于2000年在他的博士论文中提出来的一种万维网软件架构风格，目的是便于不同软件/程序在网络（例如
互联网）中互相传递信息。

目前在三种主流的Web服务实现方案中，因为REST模式与复杂的SOAP和XML-RPC相比更加简洁，越来越多的
web服务开始采用REST风格设计和实现。例如，Amazon.com提供接近REST风格的Web服务执行图书查询；
雅虎提供的Web服务也是REST风格的。

**优点**

1. 可更高效利用缓存来提高响应速度
2. 通讯本身的无状态性可以让不同的服务器的处理一系列请求中的不同请求，提高服务器的扩展性
3. 浏览器即可作为客户端，简化软件需求
4. 相对于其他叠加在HTTP协议之上的机制，REST的软件依赖性更小
5. 不需要额外的资源发现机制
6. 在软件技术演进中的长期的兼容性更好

### mongoDB

MongoDB 是由C++语言编写的，是一个基于分布式文件存储的开源数据库系统。
在高负载的情况下，添加更多的节点，可以保证服务器性能。
MongoDB 旨在为WEB应用提供可扩展的高性能数据存储解决方案。
MongoDB 将数据存储为一个文档，数据结构由键值(key=>value)对组成。MongoDB 文档类似于 JSON 
对象。字段值可以包含其他文档，数组及文档数组。

#### 优点

与关系型数据库相比，MongoDB的优点：

1. 弱一致性（最终一致），更能保证用户的访问速度：

举例来说，在传统的关系型数据库中，一个COUNT类型的操作会锁定数据集，这样可以保证得到“当前”情况下
的精确值。这在某些情况下，例 如通过ATM查看账户信息的时候很重要，但对于Wordnik来说，数据是不断
更新和增长的，这种“精确”的保证几乎没有任何意义，反而会产生很大的延 迟。他们需要的是一个“大约”的
数字以及更快的处理速度。 但某些情况下MongoDB会锁住数据库。如果此时正有数百个请求，则它们会堆积
起来，造成许多问题。我们使用了下面的优化方式来避免锁定： 每次更新前，我们会先查询记录。查询操作
会将对象放入内存，于是更新则会尽可能的迅速。

2. 文档结构的存储方式，能够更便捷的获取数据。

对于一个层级式的数据结构来说，如果要将这样的数据使用扁平式的，表状的结构来保存数据，这无论是在查
询还是获取数据时都十分困难。

3. 内置GridFS，支持大容量的存储。

GridFS是一个出色的分布式文件系统，可以支持海量的数据存储。
内置了GridFS了MongoDB，能够满足对大数据集的快速范围查询。

4. 内置Sharding。
提供基于Range的Auto Sharding机制：一个collection可按照记录的范围，分成若干个段，切分到不同
的Shard上。 Shards可以和复制结合，配合Replica sets能够实现Sharding+fail-over，不同的
Shard之间可以负载均衡。查询是对 客户端是透明的。客户端执行查询，统计，MapReduce等操作，这些会
被MongoDB自动路由到后端的数据节点。这让我们关注于自己的业务，适当的 时候可以无痛的升级。
MongoDB的Sharding设计能力最大可支持约20 petabytes，足以支撑一般应用。

#### 不足

1. 不支持事务

所以事务要求严格的系统（如果银行系统）肯定不能用它。(这点和优点1是对应的)

2. 占用空间过大

关于其原因，在官方的FAQ中，提到有如下几个方面：

    1. 空间预分配
    2. 字段名所占用的空间
    3. 删除记录不释放空间

## 功能实现

### 问题

1. (不知道还有什么问题)
2. mongoDB 不支持事务, 如何保证操作原子性? (大概知道怎么做, 但没实现)
3. pass (认证用的是阉割版SSO)

### 解决方案

1. pass

2. 官方文档中有提到使用两步提交来实现事务
mongoDB 不支持多文档事务, 但支持单文档的原子操作.
通过记录下多个文档操作的状态, 都成功时进行提交, 否则便回滚之前的操作.

另 [参考博客](https://acupple.github.io/2016/08/09/MongoDB%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%AE%9E%E7%8E%B0%E4%BA%8B%E5%8A%A1/)

3. pass

## 系统运行环境

flask-0.12

python3.6 

docker + mongodb (all the latest)

ubuntu 16.04

(扯点DevOps)


### server 

(还没搭,  用的 flask 自带的, 打算如下)

nginx + gunicorn (all the latest)

## 地图服务

(还没写)

## 即时通讯服务

(打算不写)


[server_1]: http://flask.pocoo.org/static/logo/flask.png    "flask logo"
